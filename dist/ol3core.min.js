/*! bwmaplib 05-01-2015 12:58 */

var BW=BW||{};BW.Facade=BW.Facade||{},BW.Facade.JSONConfigFacade=function(){function a(a,b){_.isString(a)&&(a=JSON.parse(a)),b(a)}return{getMapConfig:a}};var BW=BW||{};BW.Map=BW.Map||{},BW.Map.OL3Map=function(a,b){function c(a,b,c){W=b.proxyHost;var e=b.numZoomLevels,f=[];f[0]=b.newMaxRes;for(var g=1;e>g;g++)f[g]=f[g-1]/2;var h=new ol.proj.Projection({code:b.coordinate_system,extent:b.extent,units:b.extentUnits});P=new ol.Map({target:a,renderer:b.renderer,layers:[],view:new ol.View({projection:h,center:b.center,zoom:b.zoom,resolutions:f,maxResolution:b.newMaxRes,numZoomLevels:e}),controls:[],overlays:[]}),d(),c&&c(P)}function d(){var a=P.getView(),c=function(){var a=P.getView(),b=a.getCenter(),c=a.getZoom().toString();if(b&&void 0!==c){var d=b[1].toFixed(2),e=b[0].toFixed(2);return{x:d,y:e,zoom:c}}return{}},d=function(){var a=c();b.TriggerEvent(BW.Events.EventTypes.ChangeCenter,a)},e=function(){var a=c();b.TriggerEvent(BW.Events.EventTypes.ChangeResolution,a)},f=function(){Y&&(R=y(),P.render())};window.addEventListener("resize",f),a.on("change:center",d),a.on("change:resolution",e)}function e(a){var b,c,d,e=P.getView();if(a.x&&(b=a.x),a.y&&(c=a.y),a.zoom&&(d=a.zoom),void 0!==b&&void 0!==c){var f=parseFloat(c.replace(/,/g,".")),g=parseFloat(b.replace(/,/g,"."));isFinite(f)&&isFinite(g)&&e.setCenter([f,g])}void 0!==d&&e.setZoom(d)}function f(a){var b=i(a);P.addLayer(b),B()}function g(a){var b=i(a);P.getLayers().insertAt(0,b),B()}function h(a){var b=q(a.id);b&&(P.removeLayer(b),B())}function i(a){var b,c,d=j(a);if(null!=d)b=d;else{switch(a.source){case BW.MapModel.SubLayer.SOURCES.wmts:c=new BW.Map.OL3Map.WmtsSource(a);break;case BW.MapModel.SubLayer.SOURCES.proxyWmts:a.url=W+a.url,c=new BW.Map.OL3Map.WmtsSource(a);break;case BW.MapModel.SubLayer.SOURCES.wms:c=new BW.Map.OL3Map.WmsSource(a);break;case BW.MapModel.SubLayer.SOURCES.proxyWms:a.url=W+a.url,c=new BW.Map.OL3Map.WmsSource(a);break;default:throw"Unsupported source: BW.MapModel.SubLayer.SOURCES.'"+a.source+"'. For SubLayer with url "+a.url+" and name "+a.name+"."}b=a.tiled?new ol.layer.Tile({extent:a.extent,opacity:a.opacity,source:c}):new ol.layer.Image({extent:a.extent,opacity:a.opacity,source:c}),b.layerIndex=a.layerIndex,b.guid=a.id,S.push(b)}return b}function j(a){for(var b=0;b<S.length;b++){var c=S[b];if(c.guid==a.id)return c}return null}function k(a,b){var c=q(a.id);c&&!isNaN(b)&&c.setBrightness(Math.min(b,1))}function l(a,b){var c=q(a.id);c&&!isNaN(b)&&c.setContrast(Math.min(b,1))}function m(a,b){var c=q(a.id);c&&!isNaN(b)&&c.setOpacity(Math.min(b,1))}function n(a,b){var c=q(a.id);c&&!isNaN(b)&&c.setSaturation(Math.min(b,1))}function o(a,b){var c=q(a.id);c&&!isNaN(b)&&c.setHue(Math.min(b,1))}function p(){return P.getLayers().getArray().filter(function(a){return void 0!==a.guid})}function q(a){for(var b=p(),c=0;c<b.length;c++){var d=b[c];if(d.guid==a)return d}return null}function r(a){for(var b=p(),c=0;c<b.length;c++){var d=b[c];if(d.guid==a.id)return c}return null}function s(a){for(var b=p(),c=0;c<b.length;c++)if(b[c].get("title")==a)return b[c];return null}function t(a,b){var c=r(a),d=P.getLayers().getArray();d.splice(b,0,d.splice(c,1)[0]),B()}function u(){P.updateSize()}function v(){P.renderSync()}function w(a){X=a.layout,Y=!0,R=y(),Q=[P.on("precompose",Z),P.on("postcompose",_)],u()}function x(){if(Y=!1,Q)for(var a=0;a<Q.length;a++)Q[a].src.unByKey(Q[a]);u()}function y(){var a,b,c=210/297,d=P.getSize();"a4portrait"===X.value?(b=d[1]*c,b>d[0]?(b=d[0],a=d[0]/c):a=d[1]):(a=d[0]*c,a>d[1]?(a=d[1],b=d[1]/c):b=d[0]);var e=[d[0]*ol.has.DEVICE_PIXEL_RATIO/2,d[1]*ol.has.DEVICE_PIXEL_RATIO/2];return{minx:e[0]-b/2,miny:e[1]-a/2,maxx:e[0]+b/2,maxy:e[1]+a/2}}function z(){var a=P.getSize();return{height:a[1]*ol.has.DEVICE_PIXEL_RATIO,width:a[0]*ol.has.DEVICE_PIXEL_RATIO}}function A(a){P.once("postcompose",function(b){var c=b.context.canvas;a(c,R)})}function B(){b.TriggerEvent(BW.Events.EventTypes.ChangeLayers,{layers:C()})}function C(){for(var a=[],b=p(),c=0;c<b.length;c++){var d=b[c];d.getVisible()===!0&&a.push(b[c])}a.sort(D);for(var e=[],f=0;f<a.length;f++)e.push(a[f].guid);return e.join(",")}function D(a,b){return a.mapLayerIndex<b.mapLayerIndex?-1:a.mapLayerIndex>b.mapLayerIndex?1:0}function E(a){T=P.on("singleclick",function(b){a(b)})}function F(){P.unByKey(T),T=""}function G(a,b){var c=P.getView(),d=c.getResolution(),e="application/json",f=j(a),g=f.getSource(),h=c.getProjection(),i=g.getGetFeatureInfoUrl(b,d,h,{INFO_FORMAT:e,feature_count:10});return i=decodeURIComponent(i),i=i.substring(i.lastIndexOf("?"),i.length),i=i.replace("?",""),i=encodeURIComponent(i),a.url.replace("proxy/wms","proxy/")+i}function H(a){J(),I();for(var b=new ol.format.GeoJSON,c=0;c<a.length;c++){var d=a[c],e=b.readFeature(d.geometryObject);e.getGeometry().transform(ol.proj.get(d.crs),ol.proj.get(P.getView().getProjection().getCode())),U.getSource().addFeature(e)}}function I(){var a=U.getSource();a.clear()}function J(){if(null==U){null==V&&N();var a=new ol.source.GeoJSON;U=new ol.layer.Vector({source:a,style:V}),P.addLayer(U)}else P.removeLayer(U),P.addLayer(U)}function K(a,b){var c=$(b),d=c.height(),e=c.width(),f=new ol.Overlay({element:b,stopEvent:!1,offset:[-e/2,-d]});f.setPosition(a),P.addOverlay(f)}function L(a){for(var b=P.getOverlays().getArray(),c=0;c<b.length;c++){var d=b[c];d.getElement()==a&&P.removeOverlay(d)}}function M(a){V=a,U.setStyle(V)}function N(){var a=new BW.Map.OL3Map.DefaultStyle;V=a.Styles}function O(a){var b=new ol.format.WMSCapabilities,c=b.read(a);return c}var P,Q,R,S=[],T="",U=null,V=null,W="",X="",Y=!1,Z=function(a){var b=a.context;b.save()},_=function(a){var b=a.context,c=z();b.beginPath(),b.moveTo(0,0),b.lineTo(c.width,0),b.lineTo(c.width,c.height),b.lineTo(0,c.height),b.lineTo(0,0),b.closePath(),b.moveTo(R.minx,R.miny),b.lineTo(R.minx,R.maxy),b.lineTo(R.maxx,R.maxy),b.lineTo(R.maxx,R.miny),b.lineTo(R.minx,R.miny),b.closePath(),b.fillStyle="rgba(25, 25, 25, 0.75)",b.fill(),b.restore()};return{InitMap:c,ShowLayer:f,ShowBaseLayer:g,HideLayer:h,GetLayerByName:s,RegisterMapCallbacks:d,ChangeView:e,SetLayerOpacity:m,SetLayerSaturation:n,SetLayerHue:o,SetLayerBrightness:k,SetLayerContrast:l,MoveLayerToIndex:t,GetLayerIndex:r,RedrawMap:u,RenderSync:v,ExportMap:A,ActivateInfoClick:E,DeactivateInfoClick:F,GetInfoUrl:G,ShowHighlightedFeatures:H,ClearHighlightedFeatures:I,ShowInfoMarker:K,SetHighlightStyle:M,RemoveInfoMarker:L,ActivateExport:w,DeactivateExport:x,ParseGetCapabilities:O}},BW.Map.OL3Map.RENDERERS={canvas:"canvas",webgl:"webgl"},BW.Map.OL3Map.WmtsSource=function(a){for(var b=new ol.proj.Projection({code:a.coordinate_system,extent:a.extent,units:a.extentUnits}),c=b.getExtent(),d=ol.extent.getWidth(c)/256,e=new Array(14),f=new Array(14),g=18,h=0;g>h;++h)e[h]=d/Math.pow(2,h),f[h]=b.getCode()+":"+h;return new ol.source.WMTS({url:a.url,layer:a.name,format:a.format,projection:b,matrixSet:a.coordinate_system,crossOrigin:"anonymous",tileGrid:new ol.tilegrid.WMTS({origin:ol.extent.getTopLeft(c),resolutions:e,matrixIds:f})})},BW.Map.OL3Map.WmsSource=function(a){return a.tiled?new ol.source.TileWMS({params:{LAYERS:a.name,VERSION:"1.1.1"},url:a.url,format:a.format,crossOrigin:"anonymous",transparent:a.transparent}):new ol.source.ImageWMS({params:{LAYERS:a.name,VERSION:"1.1.1"},url:a.url,format:a.format,crossOrigin:"anonymous",transparent:a.transparent})},BW.Map.OL3Map.DefaultStyle=function(){var a=function(){var a=new ol.style.Fill({color:"rgba(255,255,255,0.8)"}),b=new ol.style.Stroke({color:"#3399CC",width:2.25}),c=[new ol.style.Style({image:new ol.style.Circle({fill:a,stroke:b,radius:8}),fill:a,stroke:b})];return c};return{Styles:a}};var BW=BW||{};BW.Utils=BW.Utils||{},BW.Utils.Guid=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function b(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}return{newGuid:b}};var BW=BW||{};BW.Events=BW.Events||{},BW.Events.EventHandler=function(){function a(a,b){c.push({eventType:a,callBack:b})}function b(a,b){for(var d=0;d<c.length;d++){var e=c[d];e.eventType==a&&e.callBack(b)}}var c=[];return{RegisterEvent:a,TriggerEvent:b}},BW.Events.EventTypes={ChangeCenter:"ChangeCenter",ChangeResolution:"ChangeResolution",ChangeLayers:"ChangeLayers",FeatureInfoStart:"FeatureInfoStart",FeatureInfoEnd:"FeatureInfoEnd"};var BW=BW||{};BW.MapModel=BW.MapModel||{},BW.MapModel.Layer=function(a){for(var b={subLayers:[],name:"",categoryId:0,visibleOnLoad:!0,isVisible:!1,id:(new BW.Utils.Guid).newGuid(),isBaseLayer:!1,previewActive:!1,opacity:1,mapLayerIndex:-1,legendGraphicUrls:[],selectedLayerOpen:!1},c=$.extend({},b,a),d=[],e=0;e<a.subLayers.length;e++)d.push(new BW.MapModel.SubLayer(a.subLayers[e]));return c.subLayers=d,c};var BW=BW||{};BW.MapModel=BW.MapModel||{},BW.MapModel.Map=function(a,b,c){function d(b,c,d){R=c,Q=c.layers,a.InitMap(b,c,d),g(),e(),f();for(var i=p(),j=0;j<i.length;j++){var l=i[j];l.visibleOnLoad&&n(l)}for(var m=s(),o=0;o<m.length;o++){var q=m[o];q.visibleOnLoad?h(q):k(q)}}function e(){var a=new BW.MapModel.CustomCrsLoader;a.LoadCustomCrs()}function f(){S=document.createElement("img"),S.src="assets/img/pin-md-orange.png",S.style.visibility="hidden",document.body.appendChild(S)}function g(){for(var a=0,b=p(),c=0;c<b.length;c++)for(var d=b[c],e=0;e<d.subLayers.length;e++)d.subLayers[e].layerIndex=a,a++;for(var f=s(),g=0;g<f.length;g++)for(var h=f[g],i=0;i<h.subLayers.length;i++)h.subLayers[i].layerIndex=a,a++}function h(b){for(var c=b.subLayers,d=0;d<c.length;d++){var e=c[d];a.HideLayer(e),j(e)&&a.ShowLayer(e)}b.isVisible=!0,l()}function i(b){for(var c=b.subLayers,d=0;d<c.length;d++){var e=c[d];a.HideLayer(e),j(e)&&a.ShowBaseLayer(e)}b.isVisible=!0,l()}function j(){return!0}function k(b){for(var c=b.subLayers,d=0;d<c.length;d++){var e=c[d];a.HideLayer(e)}b.isVisible=!1,b.mapLayerIndex=-1,l()}function l(){for(var a=t(),b=0;b<a.length;b++){var c=a[b];c.mapLayerIndex=A(c)}}function m(b,c){for(var d=b.subLayers,e=0;e<d.length;e++){var f=d[e];a.SetLayerOpacity(f,c)}a.RedrawMap()}function n(a){for(var b=q(),c=0;c<b.length;c++){var d=b[c];k(d)}i(a)}function o(){return void 0!==R?R.layers:[]}function p(){return o().filter(function(a){return a.isBaseLayer===!0})}function q(){return p().filter(function(a){return a.isVisible===!0})}function r(){return q()[0]}function s(){return o().filter(function(a){return a.isBaseLayer===!1})}function t(){return s().filter(function(a){return a.isVisible===!0})}function u(b){if(a.ChangeView(b),b.layers){var c=b.layers,d=c.split(",");d.forEach(function(a){var b=v(a);b&&(b.isBaseLayer===!0?n(b):h(b))})}}function v(a){for(var b=0;b<Q.length;b++){var c=Q[b];if(c.id===a)return c}}function w(b,c){for(var d=b.subLayers,e=0;e<d.length;e++){var f=d[e];j(f)&&a.MoveLayerToIndex(f,c)}l(),a.RedrawMap()}function x(b,c){for(var d=A(c),e=b.subLayers,f=0;f<e.length;f++){var g=e[f];j(g)&&a.MoveLayerToIndex(g,d)}}function y(b){a.ExportMap(b)}function z(){return a.RenderSync()}function A(b){for(var c=b.subLayers,d=[],e=0;e<c.length;e++){var f=c[e],g=a.GetLayerIndex(f);null!=g&&d.push(g)}return Math.max(d)}function B(a){a.legendGraphicUrls=[];for(var b=0;b<a.subLayers.length;b++){var c=a.subLayers[b];a.isVisible&&j(c)&&a.legendGraphicUrls.push(c.legendGraphicUrl)}}function C(){a.ActivateInfoClick(E)}function D(){a.DeactivateInfoClick()}function E(a){F(a.coordinate);var b=J(),d=I(b);c.TriggerEvent(BW.Events.EventTypes.FeatureInfoStart,d);for(var e=0;e<b.length;e++){var f=b[e][0];switch(f.source){case BW.MapModel.SubLayer.SOURCES.wmts:case BW.MapModel.SubLayer.SOURCES.wms:case BW.MapModel.SubLayer.SOURCES.proxyWms:case BW.MapModel.SubLayer.SOURCES.proxyWmts:H(f,a.coordinate,b[e][1]);break;case BW.MapModel.SubLayer.SOURCES.vector:}}}function F(b){S.style.visibility="visible",a.ShowInfoMarker(b,S)}function G(b,c){c===!0&&a.RemoveInfoMarker(S),S=b}function H(d,e,f){var g=function(a){var b,e;try{b=d.parser.Parse(a)}catch(g){e=g}var h=new BW.FeatureParser.LayerResponse;h.name=f,h.id=d.id,h.isLoading=!1,h.features=b,h.exception=e,c.TriggerEvent(BW.Events.EventTypes.FeatureInfoEnd,h)},h=a.GetInfoUrl(d,e);b.get(h).success(g)}function I(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=new BW.FeatureParser.LayerResponse;e.name=d[1],e.id=d[0].id,e.isLoading=!0,b.push(e)}return b}function J(){for(var a=[],b=t(),c=0;c<b.length;c++)for(var d=b[c],e=d.subLayers,f=0;f<e.length;f++){var g=e[f];g.isQueryable&&j(g)&&a.push([g,d.name])}return a}function K(b){a.ShowHighlightedFeatures(b)}function L(){a.ClearHighlightedFeatures()}function M(b){a.SetHighlightStyle(b)}function N(b){a.ActivateExport(b)}function O(){a.DeactivateExport()}function P(c){var d,e=function(b){var c=a.ParseGetCapabilities(b),d=c.Capability.Request.GetFeatureInfo.Format;console.log(d)},f=c.url,g="?",h=f.indexOf(g)>-1;h||(f+=encodeURIComponent(g)),d=f+encodeURIComponent("SERVICE=WMS&REQUEST=GETCAPABILITIES"),b.get(d).success(e)}var Q,R,S;return{Init:d,ShowLayer:h,HideLayer:k,GetOverlayLayers:s,GetBaseLayers:p,GetLayerById:v,GetFirstVisibleBaseLayer:r,SetBaseLayer:n,SetStateFromUrlParams:u,SetLayerOpacity:m,MoveLayerToIndex:w,MoveLayerAbove:x,SetLegendGraphics:B,RenderSync:z,ExportMap:y,ActivateInfoClick:C,DeactivateInfoClick:D,ShowHighlightedFeatures:K,ClearHighlightedFeatures:L,SetHighlightStyle:M,SetInfoMarker:G,ActivateExport:N,DeactivateExport:O,GetSupportedGetFeatureInfoFormats:P}};var BW=BW||{};BW.MapModel=BW.MapModel||{},BW.MapModel.SubLayer=function(a){var b={name:"",source:BW.MapModel.SubLayer.SOURCES.wmts,url:"",format:BW.MapModel.SubLayer.FORMATS.imagepng,coordinate_system:"",extent:[-1,1,-1,1],extentUnits:"m",id:(new BW.Utils.Guid).newGuid(),transparent:!0,layerIndex:-1,legendGraphicUrl:"",isQueryable:!0,parser:new BW.FeatureParser.ResultParser,supportedInfoFormats:[]},c=$.extend({},b,a),d=new BW.MapModel.LegendGraphic({url:c.url,layer:c.name});return c.legendGraphicUrl=d.GetLegendGraphicUrl(),c},BW.MapModel.SubLayer.SOURCES={wmts:"WMTS",wms:"WMS",vector:"VECTOR",proxyWmts:"proxyWmts",proxyWms:"proxyWms"},BW.MapModel.SubLayer.FORMATS={imagepng:"image/png",imagejpeg:"image/jpeg"};var BW=BW||{};BW.MapModel=BW.MapModel||{},BW.MapModel.LegendGraphic=function(a){function b(){return d.url+"&Request="+d.request+"&Version="+d.version+"&Format="+d.format+"&Width="+d.width+"&Height="+d.height+"&Layer="+d.layer}var c={width:"20",height:"20",format:"image/png",request:"GetLegendGraphic",version:"1.0.0",layer:"",url:""},d=$.extend({},c,a);return{GetLegendGraphicUrl:b}};var BW=BW||{};BW.MapModel=BW.MapModel||{},BW.MapModel.CustomCrsLoader=function(){function a(){window.proj4&&proj4.defs("EPSG:32633","+proj=utm +zone=33 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")}return{LoadCustomCrs:a}};var BW=BW||{};BW.Repository=BW.Repository||{},BW.Repository.ConfigRepository=function(a){function b(a){var b={numZoomLevels:18,newMaxRes:21664,center:[-20617,7661666],zoom:4,extent:[-25e5,35e5,3045984,9045984],layers:[],proxyHost:"https://www.barentswatch.no/proxy?url=",tools:[]};$.extend(b,a);for(var c=[],d=0;d<a.layers.length;d++)c.push(new BW.MapModel.Layer(a.layers[d]));return b.layers=c,b}function c(c,e){a.getMapConfig(c,function(a){d=a;var c=new BW.Repository.MapConfig(b(d));e(c)})}var d;return{GetMapConfig:c}};var BW=BW||{};BW.Repository=BW.Repository||{},BW.Repository.MapConfig=function(a){var b={numZoomLevels:10,newMaxRes:2e4,renderer:BW.Map.OL3Map.RENDERERS.canvas,center:[-1,1],zoom:5,layers:[],coordinate_system:"EPSG:32633",extent:[-1,-1,-1,-1],extentunits:"m",proxyHost:""};return $.extend({},b,a)};var BW=BW||{};BW.FeatureParser=BW.FeatureParser||{},BW.FeatureParser.ResultParser=function(){function a(a){var f="exception",g="<?xml",h="<html";return a.type?"FeatureCollection"==a.type?d(a):void 0:a.toLowerCase().indexOf(f)>-1?b(a):a.toLowerCase().indexOf(g)>-1?e(a):a.toLowerCase().indexOf(h)>-1?c(a):null}function b(a){var b=new BW.FeatureParser.Exception;b.Parse(a)}function c(a){var b=a.indexOf("<table");if(b>-1){var c=a.substring(b,a.length),d=c.indexOf("</body>");c=c.substring(0,d),console.log(c);var e=xml2json.parser(c);console.log(e)}return[]}function d(a){var b=new BW.FeatureParser.GeoJSON;return b.Parse(a)}function e(a){var b=new BW.FeatureParser.KartKlifNo;return b.Parse(a)}return{Parse:a}};var BW=this.BW||{};BW.MapCore=BW.MapCore||{},function(a){"use strict";a.setupMap=function(a,b,c){function d(b){i.Init(a,b,c)}var e=new BW.Facade.JSONConfigFacade,f=new BW.Events.EventHandler,g=new BW.Repository.ConfigRepository(e),h=new BW.Map.OL3Map(g,f),i=new BW.MapModel.Map(h,g,f);g.GetMapConfig(b,d)}}(BW.MapCore);
//# sourceMappingURL=ol3core.min.map